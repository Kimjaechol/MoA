# MoA (Master of AI) + KakaoTalk - Local Development & Testing
# Usage: docker-compose up -d

version: '3.8'

services:
  moa-kakao:
    build:
      context: ../..
      dockerfile: extensions/kakao/Dockerfile
    container_name: moa-kakao
    restart: unless-stopped
    ports:
      - "8788:8788"
    volumes:
      - moa-data:/data/.moa
    environment:
      # LLM Provider (Claude recommended)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      # Optional: OpenAI fallback
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}

      # Kakao API Credentials
      - KAKAO_ADMIN_KEY=${KAKAO_ADMIN_KEY}
      - KAKAO_APP_KEY=${KAKAO_APP_KEY:-}
      - KAKAO_CHANNEL_ID=${KAKAO_CHANNEL_ID:-}

      # Optional: Friend Talk (NHN Cloud Toast) for proactive messaging
      - KAKAO_SENDER_KEY=${KAKAO_SENDER_KEY:-}
      - TOAST_APP_KEY=${TOAST_APP_KEY:-}
      - TOAST_SECRET_KEY=${TOAST_SECRET_KEY:-}

      # Webhook Configuration
      - KAKAO_WEBHOOK_PORT=8788
      - KAKAO_WEBHOOK_PATH=/kakao/webhook

      # Gateway Settings
      - MOA_GATEWAY_MODE=local
      - NODE_ENV=production
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8788/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - moa-network

  # Optional: ngrok for local development with public URL
  ngrok:
    image: ngrok/ngrok:latest
    container_name: moa-ngrok
    restart: unless-stopped
    command:
      - "http"
      - "moa-kakao:8788"
      - "--log=stdout"
    environment:
      - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN:-}
    ports:
      - "4040:4040"  # ngrok web interface
    depends_on:
      - moa-kakao
    networks:
      - moa-network
    profiles:
      - dev  # Only start with: docker-compose --profile dev up

volumes:
  moa-data:
    driver: local

networks:
  moa-network:
    driver: bridge
