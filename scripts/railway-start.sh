#!/bin/bash
# ============================================================
# MoA Railway Unified Startup Script
#
# Starts BOTH services in a single Railway container:
#   1. OpenClaw Gateway (background) — agent with heartbeat, cron, memory, tools, skills
#   2. MoA Webhook Server (foreground) — KakaoTalk, Telegram, Discord, Slack, WhatsApp, LINE
#
# The MoA server connects to the local OpenClaw gateway for enhanced AI.
# If the gateway fails to start, MoA still works with direct LLM calls.
#
# Environment variables:
#   OPENCLAW_GATEWAY_ENABLED — "true" (default) or "false" to skip gateway
#   OPENCLAW_STATE_DIR       — Data directory (default: /data/.openclaw)
#   PORT                     — MoA server port (default: 8788, Railway overrides)
# ============================================================

# NOTE: Do NOT use `set -e` — gateway failures must never prevent MoA from starting.

echo "================================================================"
echo "[MoA] Railway Unified Startup — Master of AI + OpenClaw Agent"
echo "================================================================"

# ── Persistent data directory (Railway Volume at /data) ──
# Railway volume mounts may be root-owned; try /data first, fall back to /tmp
DATA_DIR="${OPENCLAW_STATE_DIR:-/data/.openclaw}"
if ! mkdir -p "$DATA_DIR" 2>/dev/null; then
  echo "[MoA] WARN: Cannot create $DATA_DIR (permission denied), falling back to /tmp/.openclaw"
  DATA_DIR="/tmp/.openclaw"
  mkdir -p "$DATA_DIR"
fi

# Verify the directory is writable
if ! touch "$DATA_DIR/.writetest" 2>/dev/null; then
  echo "[MoA] WARN: $DATA_DIR is not writable, falling back to /tmp/.openclaw"
  DATA_DIR="/tmp/.openclaw"
  mkdir -p "$DATA_DIR"
fi
rm -f "$DATA_DIR/.writetest" 2>/dev/null

# Set state dir so OpenClaw reads config from the volume
export OPENCLAW_STATE_DIR="$DATA_DIR"

GATEWAY_PORT=18789
GATEWAY_BIND="127.0.0.1"
GATEWAY_ENABLED="${OPENCLAW_GATEWAY_ENABLED:-true}"
GATEWAY_PID=""

# ── Create minimal OpenClaw config if not exists ──
setup_openclaw_config() {
  local config_file="$DATA_DIR/config.yaml"

  if [ -f "$config_file" ]; then
    echo "[MoA] OpenClaw config exists at $config_file"
    return 0
  fi

  if cat > "$config_file" << 'YAML'
# Auto-generated by MoA Railway startup
# This enables OpenClaw agent features (heartbeat, cron, memory, tools)
# Modify as needed — changes persist across Railway deploys (volume)

gateway:
  mode: local

agents:
  defaults:
    heartbeat:
      enabled: true
      every: "30m"
YAML
  then
    echo "[MoA] Created OpenClaw config at $config_file"
  else
    echo "[MoA] WARN: Could not write config to $config_file — gateway may not work"
  fi
}

# ── Start OpenClaw Gateway ──
start_openclaw_gateway() {
  if [ "$GATEWAY_ENABLED" != "true" ]; then
    echo "[MoA] OpenClaw gateway: DISABLED (set OPENCLAW_GATEWAY_ENABLED=true to enable)"
    return
  fi

  if [ ! -f dist/entry.js ]; then
    echo "[MoA] OpenClaw gateway: SKIPPED (dist/entry.js not found — run pnpm build first)"
    return
  fi

  setup_openclaw_config

  echo "[MoA] Starting OpenClaw gateway on $GATEWAY_BIND:$GATEWAY_PORT..."
  HOME="$DATA_DIR" node dist/entry.js gateway run \
    --port "$GATEWAY_PORT" \
    --bind "$GATEWAY_BIND" \
    --force \
    2>&1 | while IFS= read -r line; do echo "[OpenClaw] $line"; done &
  GATEWAY_PID=$!
  echo "[MoA] OpenClaw gateway PID: $GATEWAY_PID"

  # Wait for gateway to be healthy (max 30 seconds)
  echo -n "[MoA] Waiting for gateway health"
  for i in $(seq 1 30); do
    if wget -qO- "http://$GATEWAY_BIND:$GATEWAY_PORT/health" > /dev/null 2>&1; then
      echo " OK"
      echo "[MoA] OpenClaw gateway: HEALTHY"
      export MOA_OPENCLAW_GATEWAY_URL="http://$GATEWAY_BIND:$GATEWAY_PORT"
      return
    fi
    # Check if process died
    if ! kill -0 "$GATEWAY_PID" 2>/dev/null; then
      echo " FAILED"
      echo "[MoA] OpenClaw gateway: process exited — continuing without it"
      GATEWAY_PID=""
      return
    fi
    echo -n "."
    sleep 1
  done

  echo " TIMEOUT"
  echo "[MoA] OpenClaw gateway: did not become healthy in 30s — continuing without it"
}

# ── Graceful shutdown ──
cleanup() {
  echo "[MoA] Shutting down..."
  if [ -n "$GATEWAY_PID" ] && kill -0 "$GATEWAY_PID" 2>/dev/null; then
    echo "[MoA] Stopping OpenClaw gateway (PID: $GATEWAY_PID)..."
    kill "$GATEWAY_PID" 2>/dev/null || true
    wait "$GATEWAY_PID" 2>/dev/null || true
  fi
  exit 0
}
trap cleanup SIGTERM SIGINT

# ── Main ──
start_openclaw_gateway

echo ""
echo "[MoA] Starting MoA webhook server on port ${PORT:-8788}..."
echo "================================================================"

# Start MoA server (foreground) — this is the Railway-facing process
exec ./node_modules/.bin/tsx extensions/kakao/server.ts
